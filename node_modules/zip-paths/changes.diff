diff --git a/lib/index.js b/lib/index.js
index 4522b84..4f4950c 100644
--- a/lib/index.js
+++ b/lib/index.js
@@ -69,16 +69,23 @@ zipPaths.prototype.compress = function(callback) {
   if (callback == null) callback = function() {};
 
   var self = this;
-  var out = fs.createWriteStream(self.zipPath);
-  self.archiver.pipe(out);
+  var out = fs.createWriteStream(this.zipPath);
+  this.archiver.pipe(out);
 
-  async.parallel(self.asyncStack, function (err) {
-    if (err) return callback(err);
-
-    self.archiver.finalize(function (err, bytes) {
-      reset.call(self);
-      callback(err, bytes);
-    });
+  async.parallel([
+    function(cb) {
+      async.parallel(self.asyncStack, function(err) {
+        self.archiver.finalize(cb);
+      });
+    },
+    function(cb) {
+      out.once('close', function() {
+        reset.call(self);
+        cb();
+      });
+    }
+  ], function(err, results) {
+    callback(err, results[0]);
   });
 };
 
diff --git a/package.json b/package.json
index 6e5feb4..e77ea97 100644
--- a/package.json
+++ b/package.json
@@ -4,7 +4,7 @@
   "description": "Easily archive paths to zip files",
   "main": "lib/index.js",
   "scripts": {
-    "test": "rm -rf test/tmp; node_modules/.bin/coffee test/runner.coffee"
+    "test": "node_modules/.bin/coffee test/runner.coffee"
   },
   "repository": {
     "type": "git",
diff --git a/test/00_create.coffee b/test/00_create.coffee
index bd4c332..b97d9e5 100644
--- a/test/00_create.coffee
+++ b/test/00_create.coffee
@@ -10,4 +10,4 @@ test 'create tmp dir', (t) ->
     fs.stat tmpPath, (err, stat) ->
       t.error err, 'read tmp'
       t.true stat.isDirectory(), 'tmp is directory'
-      t.end()
\ No newline at end of file
+      t.end()
diff --git a/test/create_zip.coffee b/test/create_zip.coffee
index c33d8f0..def26ba 100644
--- a/test/create_zip.coffee
+++ b/test/create_zip.coffee
@@ -5,8 +5,7 @@ async = require 'async'
 zipPaths = require '../'
 exec = require('child_process').exec
 
-zipFileDir = path.resolve __dirname, 'tmp'
-zipFilePath = path.join zipFileDir, 'output.zip'
+zipFilePath = path.resolve __dirname, 'tmp', 'output.zip'
 files = ['00_create.coffee', 'runner.coffee', 'zz_cleanup.coffee']
 
 files = files.map (f) ->
diff --git a/test/runner.coffee b/test/runner.coffee
index c43a27b..7177d10 100644
--- a/test/runner.coffee
+++ b/test/runner.coffee
@@ -1,9 +1,7 @@
 glob = require 'glob'
 path = require 'path'
 
-testFiles = path.resolve(__dirname, '*.coffee')
-
-glob testFiles, (err, files) ->
+glob path.resolve(__dirname, '*.coffee'), (err, files) ->
   files.forEach (file) ->
     if not file.match __filename
       require file
